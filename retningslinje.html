<!doctype html>
<html>
  <head><title>Nasjonale retningslinjer for behandling og rehabilitering ved hjerneslag</title>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="http://yui.yahooapis.com/3.7.3/build/yui/yui-min.js"></script>
  <script type='text/javascript'>

    function showHide(button){
      var content = $('#recommendation'+button.parentElement.id.substring(1));
      content.slideToggle('normal');

      if(button.innerHTML == "[+]"){
        button.innerHTML = "[\u2013]"
      }else{
        button.innerHTML = "[+]"
      } 
    } 

    //Henter inn linker fra innholdsfortegnelsen til retningslinjene i form av JSON-objekter
    function fetchURLs(jsonObject){
      var urls = jsonObject.query.results.a;
      var no_urls = urls.length;
      window.recommendation_ID = 0;

      window.cache.add("length", no_urls);

      for(i=0; i<no_urls; i++){
        var link = urls[i].href;

        if(window.cache.retrieve("recommendation"+i) == null){
          fetchMaintext(link);
        }
      }
    }

     //Henter ut innholdet i hver link som JSON-P og legger det i output-variabelen
    function fetchMaintext(link){
      //xpath="//*[@id='recommendations']/ancestor::div/preceding-sibling::h2|//*[@id='recommendations']"
      var url = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22"+encodeURIComponent(link)+"%22%20and%20xpath%3D%22%2F%2F*%5B%40id%3D'recommendations'%5D%2Fancestor%3A%3Adiv%2Fpreceding-sibling%3A%3Ah2%7C%2F%2F*%5B%40id%3D'recommendations'%5D%22&format=html";
    
      $.ajax({
        url: url,
        processData: false,
        dataType: "html",
        success: function(data){
          if($(data)[2].firstChild.innerHTML){
            var chapterHeading = $(data)[2].firstChild.firstChild.innerHTML;
            var recommendations = $(data)[2].firstChild.children[1].innerHTML;

            window.cache.add("h"+window.recommendation_ID, chapterHeading);
            window.cache.add("url"+window.recommendation_ID, link);
            window.cache.add("recommendation"+window.recommendation_ID, recommendations);

            window.recommendation_ID++;
          }
        }
      });
    }

  function URLToArray() {
      var url = window.location.search.substring(4);
      var array = null;
      
      if(url != ""){
         array = url.substring(url.indexOf('{') + 1, url.indexOf('}')).split(',');
      }

      return array;
  }

  window.onload = function (){
    var inputArray = URLToArray();

    if(inputArray){
      for(var i=0; i<inputArray.length; i++){
        var input = parseInt(inputArray[i]);
        
        showRecommendation(input);  
      }  
    }else{
      var cacheLength = window.cache.retrieve("length").response;

      for(var i=0; i<cacheLength; i++){
        showRecommendation(i);
      }
    }

    $(".content").hide();
    $(".chapterheading").prepend("<button name='showHideBtn' onclick='showHide(this)' type='button'>[+]</button>");
  }

  function showRecommendation(ID){
    var chapterHeadingEntry = window.cache.retrieve('h'+ID);
    var urlEntry = window.cache.retrieve('url'+ID);
    var recommendationEntry = window.cache.retrieve("recommendation"+ID);

    if(chapterHeadingEntry && urlEntry && recommendationEntry){
      $('#results').append("<h3 class='chapterheading' id='h"+ID+"'><a href='"+urlEntry.response+"'>"+chapterHeadingEntry.response+"</a></h3>");
      $('#results').append("<div class='content' id='recommendation"+ID+"'>"+recommendationEntry.response+"</div>");
    }
  }

  function flushCache(){
    window.cache.flush();
  }
    </script>
  </head>
  <body>
    <div class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
        <div class="container">
          <button name="flush" value="Flush cache" onclick="flushCache()" class="btn">Flush cache</button>
       </div>
      </div>
    </div>
    <div id='results'></div>

    <!-- Initialize caching -->
    <script type='text/javascript'>
      YUI().use('cache', function (Y) {
        window.cache = new Y.CacheOffline();
      });
    </script>

    <!-- Script som kjører spørringer mot helsebiblioteket.no, via YQL. Metoden fetchURLs tar imot JSON-objekt -->
    <script src="http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fwww.helsebiblioteket.no%2FRetningslinjer%2FHjerneslag%2FInnhold%22%20and%20xpath%3D%22%2F%2F*%5B%40id%3D'leftmenu'%5D%2F%2Fa%22&format=json&callback=fetchURLs">
    </script> 
  </body>
</html>